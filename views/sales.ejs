<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Ventas - WhatsApp Bots</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .sales-container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1.5rem;
      height: calc(100vh - 200px);
    }

    .leads-sidebar {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 1rem;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }

    .leads-sidebar h3 {
      margin-top: 0;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .lead-item {
      padding: 1rem;
      margin-bottom: 0.5rem;
      background-color: var(--bg-color);
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      border: 2px solid transparent;
    }

    .lead-item:hover {
      background-color: #333;
    }

    .lead-item.active {
      border-color: var(--primary-color);
      background-color: #333;
    }

    .lead-item.unread {
      border-left: 4px solid var(--status-pending);
    }

    .lead-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .lead-preview {
      font-size: 0.85rem;
      color: #999;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .lead-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }

    .lead-badge.qualified {
      background-color: rgba(255, 193, 7, 0.2);
      color: var(--status-pending);
    }

    .lead-badge.assigned {
      background-color: rgba(40, 167, 69, 0.2);
      color: var(--status-connected);
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      background-color: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-info h3 {
      margin: 0 0 0.25rem 0;
    }

    .chat-info p {
      margin: 0.125rem 0;
      font-size: 0.85rem;
      color: #999;
    }

    .chat-messages {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background-color: #1a1a1a;
    }

    .message {
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      word-wrap: break-word;
    }

    .message.user {
      align-self: flex-start;
      background-color: #444;
    }

    .message.bot {
      align-self: flex-end;
      background-color: #5a5a5a;
    }

    .message.vendor {
      align-self: flex-end;
      background-color: var(--primary-color);
    }

    .message-sender {
      font-size: 0.75rem;
      color: #aaa;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }

    .message-text {
      margin: 0;
    }

    .message-time {
      font-size: 0.7rem;
      color: #888;
      margin-top: 0.25rem;
      text-align: right;
    }

    .chat-input {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 0.5rem;
    }

    .chat-input textarea {
      flex: 1;
      padding: 0.75rem;
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-color);
      resize: none;
      font-family: inherit;
      font-size: 14px;
    }

    .chat-input button {
      padding: 0.75rem 1.5rem;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      color: #666;
    }

    .empty-state h3 {
      margin-bottom: 0.5rem;
    }

    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      color: var(--text-color);
      font-size: 16px;
    }

    .tab:hover {
      background-color: rgba(255,255,255,0.05);
    }

    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
    }

    .btn-assign {
      background-color: var(--status-connected);
      padding: 0.5rem 1rem;
      font-size: 14px;
    }

    .btn-assign:hover {
      background-color: #1e7e34;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1> Panel de Ventas</h1>
      <div class="user-info">
        <img src="<%= user.picture %>" alt="User" class="user-avatar">
        <span><%= user.displayName %></span>
        <a href="/" class="btn btn-secondary">Dashboard</a>
        <a href="/auth/logout" class="btn btn-secondary">Cerrar Sesi贸n</a>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="qualified">Leads Calificados</button>
      <button class="tab" data-tab="assigned">Mis Conversaciones</button>
    </div>

    <div class="sales-container">
      <!-- Sidebar con lista de leads -->
      <div class="leads-sidebar">
        <h3 id="sidebar-title">Leads Calificados</h3>
        <div id="leads-list"></div>
      </div>

      <!-- rea de chat -->
      <div class="chat-container" id="chat-container">
        <div class="empty-state">
          <h3> Selecciona un lead para comenzar</h3>
          <p>Elige un contacto de la lista para ver la conversaci贸n</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const currentUserEmail = '<%= user.email %>';
    const socket = new WebSocket(`ws://${window.location.host}`);
    
    let currentTab = 'qualified';
    let selectedLeadId = null;
    let leads = {
      qualified: [],
      assigned: []
    };

    // === MANEJO DE TABS ===
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        
        document.getElementById('sidebar-title').textContent = 
          currentTab === 'qualified' ? 'Leads Calificados' : 'Mis Conversaciones';
        
        renderLeadsList();
      });
    });

    // === WEBSOCKET ===
    socket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      
      switch(message.type) {
        case 'INIT_LEADS':
          leads.qualified = message.data;
          renderLeadsList();
          break;
          
        case 'NEW_QUALIFIED_LEAD':
          leads.qualified.unshift(message.data);
          if (currentTab === 'qualified') renderLeadsList();
          showNotification('Nuevo lead calificado');
          break;
          
        case 'LEAD_ASSIGNED':
          const assignedLead = message.data;
          leads.qualified = leads.qualified.filter(l => l.id !== assignedLead.id);
          
          if (assignedLead.assignedTo === currentUserEmail) {
            leads.assigned.push(assignedLead);
          }
          
          renderLeadsList();
          
          if (selectedLeadId === assignedLead.id) {
            loadLeadChat(assignedLead.id);
          }
          break;
          
        case 'NEW_MESSAGE_FOR_SALES':
          // Marcar lead como no le铆do y mostrar notificaci贸n
          const leadWithNewMsg = leads.assigned.find(l => l.id === message.data.leadId);
          if (leadWithNewMsg) {
            leadWithNewMsg.unread = true;
            if (currentTab === 'assigned') renderLeadsList();
            
            if (selectedLeadId === message.data.leadId) {
              appendMessage('user', message.data.message, new Date().toISOString());
            } else {
              showNotification('Nuevo mensaje en conversaci贸n asignada');
            }
          }
          break;
          
        case 'MESSAGE_SENT':
          if (selectedLeadId === message.data.leadId) {
            appendMessage('vendor', message.data.message, message.data.timestamp);
          }
          break;
          
        case 'LEAD_MESSAGES':
          if (message.data.leadId === selectedLeadId) {
            renderChatView(message.data.lead, message.data.messages);
          }
          break;
      }
    };

    // Cargar leads asignados al iniciar
    socket.onopen = () => {
      fetch('/api/leads/assigned')
        .then(res => res.json())
        .then(data => {
          leads.assigned = data;
        });
    };

    // === RENDERIZAR LISTA DE LEADS ===
    function renderLeadsList() {
      const container = document.getElementById('leads-list');
      const leadsToShow = leads[currentTab];
      
      if (leadsToShow.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No hay leads disponibles</p>';
        return;
      }
      
      container.innerHTML = leadsToShow.map(lead => `
        <div class="lead-item ${lead.id === selectedLeadId ? 'active' : ''} ${lead.unread ? 'unread' : ''}" 
             data-lead-id="${lead.id}">
          <div class="lead-name">${lead.name || 'Sin nombre'}</div>
          <div class="lead-preview">${lead.email || lead.whatsappNumber}</div>
          <span class="lead-badge ${currentTab}">${currentTab === 'qualified' ? 'Calificado' : 'Asignado'}</span>
        </div>
      `).join('');
      
      // A帽adir eventos de click
      container.querySelectorAll('.lead-item').forEach(item => {
        item.addEventListener('click', () => {
          const leadId = parseInt(item.dataset.leadId);
          loadLeadChat(leadId);
        });
      });
    }

    // === CARGAR CHAT DE UN LEAD ===
    function loadLeadChat(leadId) {
      selectedLeadId = leadId;
      renderLeadsList();
      
      // Solicitar mensajes del lead
      socket.send(JSON.stringify({
        type: 'GET_LEAD_MESSAGES',
        leadId: leadId
      }));
      
      // Marcar como le铆do
      const lead = [...leads.qualified, ...leads.assigned].find(l => l.id === leadId);
      if (lead) lead.unread = false;
    }

    // === RENDERIZAR VISTA DE CHAT ===
    function renderChatView(lead, messages) {
      const container = document.getElementById('chat-container');
      
      const canAssign = currentTab === 'qualified';
      const canReply = currentTab === 'assigned';
      
      container.innerHTML = `
        <div class="chat-header">
          <div class="chat-info">
            <h3>${lead.name || 'Sin nombre'}</h3>
            <p> ${lead.email || 'No proporcionado'}</p>
            <p> ${lead.location || 'No proporcionado'}</p>
            <p> ${lead.phone || lead.whatsappNumber}</p>
          </div>
          ${canAssign ? `<button class="btn btn-assign" onclick="assignLeadToMe(${lead.id})">Tomar Lead</button>` : ''}
        </div>
        <div class="chat-messages" id="chat-messages">
          ${messages.map(msg => createMessageHTML(msg.sender, msg.message, msg.timestamp)).join('')}
        </div>
        ${canReply ? `
          <div class="chat-input">
            <textarea id="message-input" placeholder="Escribe un mensaje..." rows="2"></textarea>
            <button class="btn" onclick="sendMessage()">Enviar</button>
          </div>
        ` : ''}
      `;
      
      // Scroll al final
      const messagesContainer = document.getElementById('chat-messages');
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // Enter para enviar
      if (canReply) {
        document.getElementById('message-input').addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    }

    // === CREAR HTML DE MENSAJE ===
    function createMessageHTML(sender, message, timestamp) {
      const date = new Date(timestamp);
      const timeStr = date.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
      
      let senderLabel = sender;
      let messageClass = 'user';
      
      if (sender === 'bot') {
        senderLabel = ' Bot';
        messageClass = 'bot';
      } else if (sender !== 'user') {
        senderLabel = sender;
        messageClass = 'vendor';
      } else {
        senderLabel = 'Cliente';
      }
      
      return `
        <div class="message ${messageClass}">
          <div class="message-sender">${senderLabel}</div>
          <p class="message-text">${message}</p>
          <div class="message-time">${timeStr}</div>
        </div>
      `;
    }

    // === AADIR MENSAJE AL CHAT ===
    function appendMessage(sender, message, timestamp) {
      const messagesContainer = document.getElementById('chat-messages');
      if (!messagesContainer) return;
      
      const messageHTML = createMessageHTML(sender, message, timestamp);
      messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // === ASIGNAR LEAD ===
    function assignLeadToMe(leadId) {
      socket.send(JSON.stringify({
        type: 'ASSIGN_LEAD',
        leadId: leadId,
        vendorEmail: currentUserEmail
      }));
      
      // Cambiar a la pesta帽a de asignados
      document.querySelector('.tab[data-tab="assigned"]').click();
    }

    // === ENVIAR MENSAJE ===
    function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      
      if (!message || !selectedLeadId) return;
      
      socket.send(JSON.stringify({
        type: 'SEND_MESSAGE',
        leadId: selectedLeadId,
        message: message,
        vendorEmail: currentUserEmail
      }));
      
      input.value = '';
    }

    // === NOTIFICACIN ===
    function showNotification(text) {
      if (Notification.permission === 'granted') {
        new Notification('Panel de Ventas', { body: text });
      }
    }

    // Solicitar permisos de notificaci贸n
    if (Notification.permission === 'default') {
      Notification.requestPermission();
    }
  </script>
</body>
</html>