<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Ventas - WhatsApp Bots</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .sales-container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1.5rem;
      height: calc(100vh - 200px);
    }

    .leads-sidebar {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 1rem;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }

    .leads-sidebar h3 {
      margin-top: 0;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .lead-item {
      padding: 1rem;
      margin-bottom: 0.5rem;
      background-color: var(--bg-color);
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      border: 2px solid transparent;
    }

    .lead-item:hover {
      background-color: #333;
    }

    .lead-item.active {
      border-color: var(--primary-color);
      background-color: #333;
    }

    .lead-item.unread {
      border-left: 4px solid var(--status-pending);
    }

    .lead-name {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .lead-preview {
      font-size: 0.85rem;
      color: #999;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .lead-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }

    .lead-badge.qualified {
      background-color: rgba(255, 193, 7, 0.2);
      color: var(--status-pending);
    }

    .lead-badge.assigned {
      background-color: rgba(40, 167, 69, 0.2);
      color: var(--status-connected);
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      background-color: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      overflow: hidden;
    }

    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-info h3 {
      margin: 0 0 0.25rem 0;
    }

    .chat-info p {
      margin: 0.125rem 0;
      font-size: 0.85rem;
      color: #999;
    }

    .chat-messages {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background-color: #1a1a1a;
    }

    .message {
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      word-wrap: break-word;
    }

    .message.user {
      align-self: flex-start;
      background-color: #444;
    }

    .message.bot {
      align-self: flex-end;
      background-color: #5a5a5a;
    }

    .message.vendor {
      align-self: flex-end;
      background-color: var(--primary-color);
    }

    .message-sender {
      font-size: 0.75rem;
      color: #aaa;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }

    .message-text {
      margin: 0;
    }

    .message-time {
      font-size: 0.7rem;
      color: #888;
      margin-top: 0.25rem;
      text-align: right;
    }

    .chat-input {
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: 0.5rem;
    }

    .chat-input textarea {
      flex: 1;
      padding: 0.75rem;
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-color);
      resize: none;
      font-family: inherit;
      font-size: 14px;
    }

    .chat-input button {
      padding: 0.75rem 1.5rem;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      color: #666;
    }

    .empty-state h3 {
      margin-bottom: 0.5rem;
    }

    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      color: var(--text-color);
      font-size: 16px;
    }

    .tab:hover {
      background-color: rgba(255,255,255,0.05);
    }

    .tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
    }

    .btn-assign {
      background-color: var(--status-connected);
      padding: 0.5rem 1rem;
      font-size: 14px;
    }

    .btn-assign:hover {
      background-color: #1e7e34;
    }
  </style>
</head>
<body>
  <div class="container">
 <!-- sales.ejs -->
<header>
  <h1>üíº Panel de Ventas</h1>
  <div class="user-info">
    <img src="<%= user.picture %>" alt="User" class="user-avatar">
    <span><%= user.displayName %></span>
    
    <!-- Mostrar rol -->
    <span style="background: <%= user.role === 'admin' ? '#28a745' : '#007bff' %>; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">
      <%= user.role === 'admin' ? 'üëë Admin' : 'üë§ Vendedor' %>
    </span>
    
    <!-- Solo mostrar el bot√≥n de Dashboard si es admin -->
    <% if (user.role === 'admin') { %>
      <a href="/" class="btn btn-secondary">‚öôÔ∏è Gestionar Bots</a>
    <% } %>
    
    <a href="/auth/logout" class="btn btn-secondary">Cerrar Sesi√≥n</a>
  </div>
</header>

    <div class="tabs">
      <button class="tab active" data-tab="qualified">Leads Calificados</button>
      <button class="tab" data-tab="assigned">Mis Conversaciones</button>
    </div>

    <div class="sales-container">
      <!-- Sidebar con lista de leads -->
      <div class="leads-sidebar">
        <h3 id="sidebar-title">Leads Calificados</h3>
        <div id="leads-list"></div>
      </div>

      <!-- √Årea de chat -->
      <div class="chat-container" id="chat-container">
        <div class="empty-state">
          <h3>üì≠ Selecciona un lead para comenzar</h3>
          <p>Elige un contacto de la lista para ver la conversaci√≥n</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const currentUserEmail = '<%= user.email %>';
    const socket = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}`);
    let loadedMessagesCount = 50; 
    let currentTab = 'qualified';
    let selectedLeadId = null;
    let leads = {
      qualified: [],
      assigned: []
    };

    // === MANEJO DE TABS ===
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        
        document.getElementById('sidebar-title').textContent = 
          currentTab === 'qualified' ? 'Leads Calificados' : 'Mis Conversaciones';
        
        renderLeadsList();
      });
    });

    // === WEBSOCKET ===
    socket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      
      switch(message.type) {
        case 'INIT_LEADS':
          leads.qualified = message.data;
          renderLeadsList();
          break;
          
        case 'NEW_QUALIFIED_LEAD':
          leads.qualified.unshift(message.data);
          if (currentTab === 'qualified') renderLeadsList();
          showNotification('Nuevo lead calificado');
          break;
          
        case 'LEAD_ASSIGNED':
          const assignedLead = message.data;
          leads.qualified = leads.qualified.filter(l => l.id !== assignedLead.id);
          
          if (assignedLead.assignedTo === currentUserEmail) {
            leads.assigned.push(assignedLead);
          }
          
          renderLeadsList();
          
          if (selectedLeadId === assignedLead.id) {
            loadLeadChat(assignedLead.id);
          }
          break;
          
        case 'NEW_MESSAGE_FOR_SALES':
          // Marcar lead como no le√≠do y mostrar notificaci√≥n
          const leadWithNewMsg = leads.assigned.find(l => l.id === message.data.leadId);
          if (leadWithNewMsg) {
            leadWithNewMsg.unread = true;
            if (currentTab === 'assigned') renderLeadsList();
            
            if (selectedLeadId === message.data.leadId) {
              appendMessage('user', message.data.message, new Date().toISOString());
            } else {
              showNotification('Nuevo mensaje en conversaci√≥n asignada');
            }
          }
          break;
          
        case 'MESSAGE_SENT':
          if (selectedLeadId === message.data.leadId) {
            appendMessage('vendor', message.data.message, message.data.timestamp);
          }
          break;
          
        case 'LEAD_MESSAGES':
          if (message.data.leadId === selectedLeadId) {
            renderChatView(message.data.lead, message.data.messages);
          }
          break;
      }
    };

    // Cargar leads asignados al iniciar
    socket.onopen = () => {
      fetch('/api/leads/assigned')
        .then(res => res.json())
        .then(data => {
          leads.assigned = data;
        });
    };

    // === RENDERIZAR LISTA DE LEADS ===
    function renderLeadsList() {
      const container = document.getElementById('leads-list');
      const leadsToShow = leads[currentTab];
      
      if (leadsToShow.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No hay leads disponibles</p>';
        return;
      }
      
      container.innerHTML = leadsToShow.map(lead => `
        <div class="lead-item ${lead.id === selectedLeadId ? 'active' : ''} ${lead.unread ? 'unread' : ''}" 
             data-lead-id="${lead.id}">
          <div class="lead-name">${lead.name || 'Sin nombre'}</div>
          <div class="lead-preview">${lead.email || lead.whatsappNumber}</div>
          <span class="lead-badge ${currentTab}">${currentTab === 'qualified' ? 'Calificado' : 'Asignado'}</span>
        </div>
      `).join('');
      
      // A√±adir eventos de click
      container.querySelectorAll('.lead-item').forEach(item => {
        item.addEventListener('click', () => {
          const leadId = parseInt(item.dataset.leadId);
          loadLeadChat(leadId);
        });
      });
    }

    // === CARGAR CHAT DE UN LEAD ===
    function loadLeadChat(leadId) {
      selectedLeadId = leadId;
      renderLeadsList();
      
      // Solicitar mensajes del lead
      socket.send(JSON.stringify({
        type: 'GET_LEAD_MESSAGES',
        leadId: leadId
      }));
      
      // Marcar como le√≠do
      const lead = [...leads.qualified, ...leads.assigned].find(l => l.id === leadId);
      if (lead) lead.unread = false;
    }

    // === RENDERIZAR VISTA DE CHAT ===
    function renderChatView(lead, messages) {
    const container = document.getElementById('chat-container');
    
    const canAssign = currentTab === 'qualified';
    const canReply = currentTab === 'assigned';
    const totalMessages = messages.length;
    
    // Si hay muchos mensajes, mostrar solo los √∫ltimos 50 inicialmente
    const messagesToShow = totalMessages > 50 ? messages.slice(-50) : messages;
    const hasMoreMessages = totalMessages > messagesToShow.length;
    
    container.innerHTML = `
        <div class="chat-header">
            <div class="chat-info">
            <h3>${lead.name || 'Sin nombre'}</h3>
            <p>üìß ${lead.email || 'No proporcionado'}</p>
            <p>üìç ${lead.location || 'No proporcionado'}</p>
            <p>üìû ${lead.phone || lead.whatsappNumber}</p>
            ${lead.phone === lead.whatsappNumber ? 
                '<p style="font-size: 0.8rem; color: #888;">üí¨ Tel√©fono de contacto: WhatsApp</p>' : 
                '<p style="font-size: 0.8rem; color: #888;">üí¨ WhatsApp: ' + lead.whatsappNumber + '</p>'
            }
        </div>
            ${canAssign ? `<button class="btn btn-assign" onclick="assignLeadToMe(${lead.id})">Tomar Lead</button>` : ''}
        </div>
        <div class="chat-messages" id="chat-messages">
            ${hasMoreMessages ? `
                <div id="load-more-container" style="text-align: center; padding: 1rem;">
                    <button class="btn btn-secondary" onclick="loadMoreMessages(${lead.id}, ${totalMessages})">
                        ‚¨ÜÔ∏è Cargar mensajes anteriores (${totalMessages - messagesToShow.length} restantes)
                    </button>
                </div>
            ` : ''}
            <div id="messages-container">
                ${messagesToShow.map(msg => createMessageHTML(msg.sender, msg.message, msg.timestamp)).join('')}
            </div>
        </div>
        ${canReply ? `
            <div class="chat-input">
                <textarea id="message-input" placeholder="Escribe un mensaje..." rows="2"></textarea>
                <button class="btn" onclick="sendMessage()">Enviar</button>
            </div>
        ` : ''}
    `;
    
    // Guardar referencia a todos los mensajes
    container.dataset.allMessages = JSON.stringify(messages);
    container.dataset.currentCount = messagesToShow.length;
    
    // Scroll al final
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Enter para enviar si puede responder
    if (canReply) {
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
    }
}
    // === CREAR HTML DE MENSAJE ===
    function createMessageHTML(sender, message, timestamp) {
      const date = new Date(timestamp);
      const timeStr = date.toLocaleTimeString('es', { hour: '2-digit', minute: '2-digit' });
      
      let senderLabel = sender;
      let messageClass = 'user';
      
      if (sender === 'bot') {
        senderLabel = 'ü§ñ Bot';
        messageClass = 'bot';
      } else if (sender !== 'user') {
        senderLabel = sender;
        messageClass = 'vendor';
      } else {
        senderLabel = 'Cliente';
      }
      
      return `
        <div class="message ${messageClass}">
          <div class="message-sender">${senderLabel}</div>
          <p class="message-text">${message}</p>
          <div class="message-time">${timeStr}</div>
        </div>
      `;
    }

    // === A√ëADIR MENSAJE AL CHAT ===
    function appendMessage(sender, message, timestamp) {
      const messagesContainer = document.getElementById('chat-messages');
      if (!messagesContainer) return;
      
      const messageHTML = createMessageHTML(sender, message, timestamp);
      messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // === ASIGNAR LEAD ===
    function assignLeadToMe(leadId) {
      socket.send(JSON.stringify({
        type: 'ASSIGN_LEAD',
        leadId: leadId,
        vendorEmail: currentUserEmail
      }));
      
      // Cambiar a la pesta√±a de asignados
      document.querySelector('.tab[data-tab="assigned"]').click();
    }

    // === ENVIAR MENSAJE ===
    function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();
      
      if (!message || !selectedLeadId) return;
      
      socket.send(JSON.stringify({
        type: 'SEND_MESSAGE',
        leadId: selectedLeadId,
        message: message,
        vendorEmail: currentUserEmail
      }));
      
      input.value = '';
    }

    // === NOTIFICACI√ìN ===
    function showNotification(text) {
      if (Notification.permission === 'granted') {
        new Notification('Panel de Ventas', { body: text });
      }
    }

    // Solicitar permisos de notificaci√≥n
    if (Notification.permission === 'default') {
      Notification.requestPermission();
    }

    function loadMoreMessages(leadId, totalMessages) {
    const container = document.getElementById('chat-container');
    const allMessages = JSON.parse(container.dataset.allMessages);
    const currentCount = parseInt(container.dataset.currentCount);
    
    // Cargar 50 mensajes m√°s cada vez
    const newCount = Math.min(currentCount + 50, totalMessages);
    const messagesToShow = allMessages.slice(-(newCount));
    
    // Actualizar solo la secci√≥n de mensajes
    const messagesSection = document.getElementById('chat-messages');
    const previousScrollHeight = messagesSection.scrollHeight;
    const previousScrollTop = messagesSection.scrollTop;
    
    // Renderizar mensajes actualizados
    let messagesHTML = '';
    
    // Si a√∫n quedan mensajes por cargar, mantener el bot√≥n
    if (newCount < totalMessages) {
        messagesHTML += `
            <div id="load-more-container" style="text-align: center; padding: 1rem;">
                <button class="btn btn-secondary" onclick="loadMoreMessages(${leadId}, ${totalMessages})">
                    ‚¨ÜÔ∏è Cargar mensajes anteriores (${totalMessages - newCount} restantes)
                </button>
            </div>
        `;
    }
    
    messagesHTML += '<div id="messages-container">';
    messagesHTML += messagesToShow.map(msg => createMessageHTML(msg.sender, msg.message, msg.timestamp)).join('');
    messagesHTML += '</div>';
    
    messagesSection.innerHTML = messagesHTML;
    
    // Mantener la posici√≥n de scroll relativa
    const newScrollHeight = messagesSection.scrollHeight;
    const scrollDiff = newScrollHeight - previousScrollHeight;
    messagesSection.scrollTop = previousScrollTop + scrollDiff;
    
    // Actualizar contador
    container.dataset.currentCount = newCount;
    
    // Actualizar texto informativo
    const chatInfo = document.querySelector('.chat-info p[style*="color: #888"]');
    if (chatInfo) {
        chatInfo.textContent = `üí¨ Mostrando ${newCount} de ${totalMessages} mensajes`;
    }
}
async function loadAllMessages(leadId) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Cargando...';
    
    try {
        // Hacer petici√≥n para obtener TODOS los mensajes
        const response = await fetch(`/api/leads/${leadId}/messages?limit=9999`);
        const data = await response.json();
        
        if (data.messages && data.lead) {
            // Renderizar con todos los mensajes
            renderFullChatView(data.lead, data.messages);
        }
    } catch (error) {
        console.error('Error cargando mensajes:', error);
        btn.disabled = false;
        btn.textContent = 'Error - Reintentar';
    }
}
function renderFullChatView(lead, messages) {
    const container = document.getElementById('chat-container');
    const canAssign = currentTab === 'qualified';
    const canReply = currentTab === 'assigned';
    
    container.innerHTML = `
        <div class="chat-header">
            <div class="chat-info">
                <h3>${lead.name || 'Sin nombre'}</h3>
                <p>üìß ${lead.email || 'No proporcionado'}</p>
                <p>üìç ${lead.location || 'No proporcionado'}</p>
                <p>üìû ${lead.phone || lead.whatsappNumber}</p>
                <p style="color: #88ff88; font-size: 0.8rem;">
                    ‚úÖ Todos los mensajes cargados (${messages.length} total)
                </p>
            </div>
            ${canAssign ? `<button class="btn btn-assign" onclick="assignLeadToMe(${lead.id})">Tomar Lead</button>` : ''}
        </div>
        <div class="chat-messages" id="chat-messages">
            <div id="messages-container">
                ${messages.map(msg => createMessageHTML(msg.sender, msg.message, msg.timestamp)).join('')}
            </div>
        </div>
        ${canReply ? `
            <div class="chat-input">
                <textarea id="message-input" placeholder="Escribe un mensaje..." rows="2"></textarea>
                <button class="btn" onclick="sendMessage()">Enviar</button>
            </div>
        ` : ''}
    `;
    
    // Scroll al final despu√©s de cargar todo
    setTimeout(() => {
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 100);
    
    // Re-a√±adir listener para Enter si puede responder
    if (canReply) {
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }
    }
}
const additionalStyles = `
<style>
    .btn-secondary {
        background-color: #555;
        color: white;
        border: 1px solid #666;
    }
    
    .btn-secondary:hover {
        background-color: #666;
    }
    
    #load-more-container {
        position: sticky;
        top: 0;
        background: linear-gradient(to bottom, rgba(26,26,26,1) 0%, rgba(26,26,26,0.9) 80%, transparent 100%);
        z-index: 10;
        padding: 1rem !important;
    }
    
    .chat-messages {
        position: relative;
    }
    
    #messages-container {
        padding-top: 0.5rem;
    }
</style>
`;

document.head.insertAdjacentHTML('beforeend', additionalStyles);
  </script>
</body>
</html>